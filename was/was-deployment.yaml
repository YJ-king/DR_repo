apiVersion: apps/v1
kind: Deployment
metadata:
  name: was-deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      app: was
  template:
    metadata:
      labels:
        app: was
    spec:
      containers:
      - name: was
        image: asia-northeast3-docker.pkg.dev/kdt1-finalproject/yj-repo/yj-was:was-20250706-05
        ports:
        - containerPort: 8080
        command: ["/bin/bash", "-c"]
        args:
          - |
            echo "DB_HOST=${DB_HOST}" >> /etc/environment
            echo "DB_NAME=${DB_NAME}" >> /etc/environment
            echo "DB_USER=${DB_USER}" >> /etc/environment
            echo "DB_PASSWORD=${DB_PASSWORD}" >> /etc/environment
            source /etc/environment

            cat <<EOF > /opt/tomcat/webapps/ROOT/WEB-INF/classes/application.properties
            spring.datasource.url=jdbc:mysql://${DB_HOST}:3306/${DB_NAME}?autoReconnect=true&failOverReadOnly=false&connectTimeout=2000&socketTimeout=3000&maxReconnects=3
            spring.datasource.username=${DB_USER}
            spring.datasource.password=${DB_PASSWORD}
            spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

            spring.jpa.hibernate.ddl-auto=update
            spring.jpa.show-sql=true
            server.port=8080
            spring.datasource.hikari.connection-init-sql=SET NAMES utf8mb4
            spring.datasource.hikari.connection-test-query=SELECT 1
            EOF

            # 기타 설정 파일 치환
            for f in \
              /opt/tomcat/WEB-INF/classes/application.properties \
              /opt/tomcat/webapps/ROOT/WEB-INF/classes/spring/data-access.properties \
              /opt/tomcat/webapps/ROOT/WEB-INF/classes/spring/datasource-config.xml \
              /opt/tomcat/webapps/ROOT/META-INF/maven/org.springframework.samples/spring-framework-petclinic/pom.xml
            ; do
              sed -i "s|\\\$DB_HOST|${DB_HOST}|g" "$f"
            done

            exec /opt/tomcat/bin/catalina.sh run;

        env:
        - name: DB_HOST
          value: "<RDS_ENDPOINT>"  # terraform output로 치환될 값
        - name: DB_NAME
          value: "petclinic"
        - name: DB_USER
          value: "petuser"
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: db-secret
              key: password


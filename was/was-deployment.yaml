apiVersion: apps/v1
kind: Deployment
metadata:
  name: was-deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      app: was
  template:
    metadata:
      labels:
        app: was
    spec:
      imagePullSecrets:
      - name: regcred

      containers:
      - name: was
        image: asia-northeast3-docker.pkg.dev/kdt1-finalproject/yj-repo/yj-was:was-20250706-05
        ports:
        - containerPort: 8080
        command: ["/bin/bash", "-c"]
        args:
          - |
            # 2. ÏïïÏ∂ï Ìï¥Ï†úÎê† ÎïåÍπåÏßÄ ÎåÄÍ∏∞ (ÏµúÎåÄ 10Ï¥àÍπåÏßÄ Í∏∞Îã§Î¶º)
            for i in {1..10}; do
              if [ -f /usr/local/tomcat/webapps/ROOT/WEB-INF/classes/application.properties ]; then
                echo "üì¶ ROOT.war ÏïïÏ∂ï Ìï¥Ï†ú ÏôÑÎ£å"
                break
              fi
              echo "‚è≥ ROOT.war ÏïïÏ∂ï ÎåÄÍ∏∞Ï§ë... ($i)"
              sleep 1
            done

            # 3. ÌôòÍ≤ΩÎ≥ÄÏàò ÌååÏùºÎ°ú Ï†ÄÏû•
            echo "DB_HOST=${DB_HOST}" >> /etc/environment
            echo "DB_NAME=${DB_NAME}" >> /etc/environment
            echo "DB_USER=${DB_USER}" >> /etc/environment
            echo "DB_PASSWORD=${DB_PASSWORD}" >> /etc/environment
            source /etc/environment

            # 4. application.properties Ïû¨ÏûëÏÑ±
            cat <<EOF > /usr/local/tomcat/webapps/ROOT/WEB-INF/classes/application.properties
            spring.datasource.url=jdbc:mysql://${DB_HOST}:3306/${DB_NAME}?autoReconnect=true&failOverReadOnly=false&connectTimeout=2000&socketTimeout=3000&maxReconnects=3
            spring.datasource.username=${DB_USER}
            spring.datasource.password=${DB_PASSWORD}
            spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

            spring.jpa.hibernate.ddl-auto=update
            spring.jpa.show-sql=true
            server.port=8080
            spring.datasource.hikari.connection-init-sql=SET NAMES utf8mb4
            spring.datasource.hikari.connection-test-query=SELECT 1
            EOF

            # 5. ÏÑ§Ï†ï ÌååÏùº ÎÇ¥ DB_HOST Í∞í ÏπòÌôò
            for f in \
              /usr/local/tomcat/webapps/ROOT/WEB-INF/classes/application.properties \
              /usr/local/tomcat/webapps/ROOT/WEB-INF/classes/spring/data-access.properties \
              /usr/local/tomcat/webapps/ROOT/WEB-INF/classes/spring/datasource-config.xml \
              /usr/local/tomcat/webapps/ROOT/META-INF/maven/org.springframework.samples/spring-framework-petclinic/pom.xml; do
              [ -f "$f" ] && sed -i "s|\\\$DB_HOST|${DB_HOST}|g" "$f"
            done

            # 6. catalina.sh runÏúºÎ°ú Ïû¨Ïã§Ìñâ
            exec /usr/local/tomcat/bin/catalina.sh run


        env:
        - name: DB_HOST
          value: "<RDS_ENDPOINT>"  # terraform outputÎ°ú ÏπòÌôòÎê† Í∞í
        - name: DB_NAME
          value: "petclinic"
        - name: DB_USER
          value: "petuser"
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: db-secret
              key: password

